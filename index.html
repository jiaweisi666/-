<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>词法分析器 - 前后端分离版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#06b6d4',
                        light: '#f8fafc',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Fira Code', 'monospace']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .editor-line {
                @apply py-1 border-l-2 border-transparent hover:bg-gray-100;
            }
            .editor-line-number {
                @apply inline-block w-8 text-right mr-2 text-gray-400 select-none;
            }
            .token-keyword {
                @apply text-blue-600;
            }
            .token-identifier {
                @apply text-green-600;
            }
            .token-number {
                @apply text-purple-600;
            }
            .token-operator {
                @apply text-orange-600;
            }
            .token-delimiter {
                @apply text-red-600;
            }
            .token-comment {
                @apply text-gray-400;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fa fa-code mr-2 text-primary"></i>词法分析器
                <span class="text-sm font-normal text-gray-500 ml-2">前后端分离版</span>
            </h1>
            <div class="flex space-x-2">
                <button id="loadExampleBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">
                    <i class="fa fa-file-text-o mr-1"></i>加载示例
                </button>
                <button id="clearBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">
                    <i class="fa fa-trash-o mr-1"></i>清空
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 代码编辑区域 -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="p-3 bg-gray-100 border-b flex justify-between items-center">
                    <h2 class="font-medium text-gray-700">
                        <i class="fa fa-pencil mr-2 text-primary"></i>代码编辑
                    </h2>
                    <button id="analyzeBtn" class="px-4 py-1 bg-primary text-white rounded hover:bg-blue-600">
                        <i class="fa fa-play mr-1"></i>分析
                    </button>
                </div>
                <div class="relative">
                    <div id="lineNumbers" class="absolute top-0 left-0 bottom-0 w-12 bg-gray-100 text-right pt-3 pb-3 text-xs text-gray-500 overflow-hidden"></div>
                    <textarea id="codeEditor" class="w-full h-96 p-3 pl-12 font-mono text-sm bg-white resize-none focus:outline-none" placeholder="请输入代码..."></textarea>
                </div>
            </div>

            <!-- 分析结果区域 -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="p-3 bg-gray-100 border-b">
                    <h2 class="font-medium text-gray-700">
                        <i class="fa fa-list-alt mr-2 text-primary"></i>分析结果
                    </h2>
                </div>
                <div id="resultContainer" class="p-4 h-96 overflow-y-auto">
                    <div id="resultPlaceholder" class="flex flex-col items-center justify-center h-full text-gray-400">
                        <i class="fa fa-info-circle text-4xl mb-2"></i>
                        <p>请在左侧输入代码并点击"分析"按钮</p>
                    </div>
                    <div id="resultContent" class="hidden">
                        <div class="mb-4">
                            <h3 class="font-medium text-gray-700 mb-2">Token列表</h3>
                            <div id="tokenList" class="space-y-1"></div>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-700 mb-2">语法高亮</h3>
                            <pre id="highlightedCode" class="font-mono text-sm bg-gray-50 p-3 rounded overflow-x-auto"></pre>
                        </div>
                    </div>
                    <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <p class="mt-2 text-gray-500">正在分析代码...</p>
                    </div>
                    <div id="errorMessage" class="hidden flex flex-col items-center justify-center h-full text-red-500">
                        <i class="fa fa-exclamation-triangle text-4xl mb-2"></i>
                        <p id="errorText"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 种别码说明 -->
        <div class="mt-6 bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="p-3 bg-gray-100 border-b">
                <h2 class="font-medium text-gray-700">
                    <i class="fa fa-book mr-2 text-primary"></i>种别码说明
                </h2>
            </div>
            <div class="p-4 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">单词符号</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">种别码</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">单词符号</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">种别码</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">单词符号</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">种别码</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">begin</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">1</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">double</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">12</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">:=</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">23</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">if</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">2</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">char</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">13</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">&lt;</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">24</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">then</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">3</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">break</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">14</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">&lt;&gt;</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">25</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">while</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">4</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">continue</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">15</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">&lt;=</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">26</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">do</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">5</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">ID</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">16</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">&gt;</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">27</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">end</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">6</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">NUM</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">17</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">&gt;=</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">28</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">main</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">7</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">+</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">18</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">=</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">29</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">int</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">8</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">-</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">19</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">==</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">30</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">float</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">9</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">*</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">20</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">;</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">31</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">for</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">10</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">/</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">21</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">(</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">32</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">else</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">11</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">%</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">22</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900">)</td>
                            <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-500">33</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="bg-white mt-6 py-4 border-t">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>© 2025 词法分析器 | 前后端分离架构</p>
        </div>
    </footer>

    <script>
        // DOM元素
        const codeEditor = document.getElementById('codeEditor');
        const lineNumbers = document.getElementById('lineNumbers');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultPlaceholder = document.getElementById('resultPlaceholder');
        const resultContent = document.getElementById('resultContent');
        const tokenList = document.getElementById('tokenList');
        const highlightedCode = document.getElementById('highlightedCode');
        const loadExampleBtn = document.getElementById('loadExampleBtn');
        const clearBtn = document.getElementById('clearBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        // API基础URL
        const API_BASE_URL = 'http://localhost:5000/api';

        // 更新行号
        function updateLineNumbers() {
            const lines = codeEditor.value.split('\n');
            lineNumbers.innerHTML = lines.map((_, i) => `<div class="px-2 py-1">${i + 1}</div>`).join('');
        }

        // 初始化行号
        codeEditor.addEventListener('input', updateLineNumbers);
        updateLineNumbers();

        // 加载示例代码
        loadExampleBtn.addEventListener('click', async function() {
            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/example`);
                const data = await response.json();

                if (data.success) {
                    codeEditor.value = data.code;
                    updateLineNumbers();
                    hideAllMessages();
                    showPlaceholder();
                } else {
                    showError(data.error || '加载示例代码失败');
                }
            } catch (error) {
                showError('网络错误，无法加载示例代码');
                console.error(error);
            } finally {
                hideLoading();
            }
        });

        // 清空代码
        clearBtn.addEventListener('click', function() {
            codeEditor.value = '';
            updateLineNumbers();
            hideAllMessages();
            showPlaceholder();
        });

        // 分析代码
        analyzeBtn.addEventListener('click', async function() {
            const code = codeEditor.value;
            if (!code.trim()) {
                alert('请输入代码');
                return;
            }

            try {
                showLoading();

                // 发送请求到后端API
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: code }),
                });

                const data = await response.json();

                if (data.success) {
                    // 显示结果
                    displayResults(data.tokens, code);
                    hideAllMessages();
                    showResult();
                } else {
                    showError(data.error || '分析失败');
                }
            } catch (error) {
                showError('网络错误，无法连接到服务器');
                console.error(error);
            } finally {
                hideLoading();
            }
        });

        // 显示分析结果
        function displayResults(tokens, code) {
            // 显示Token列表
            tokenList.innerHTML = '';
            tokens.forEach(token => {
                const tokenItem = document.createElement('div');
                tokenItem.className = 'flex items-center p-2 border-b border-gray-100 hover:bg-gray-50';

                const tokenType = document.createElement('span');
                tokenType.className = `inline-block w-24 font-medium ${getTokenTypeClass(token.type)}`;
                tokenType.textContent = token.value;

                const tokenCode = document.createElement('span');
                tokenCode.className = 'text-gray-500';
                tokenCode.textContent = `种别码: ${token.code}`;

                tokenItem.appendChild(tokenType);
                tokenItem.appendChild(tokenCode);
                tokenList.appendChild(tokenItem);
            });

            // 显示语法高亮
            highlightedCode.innerHTML = highlightCode(code);
        }

        // 获取Token类型对应的CSS类
        function getTokenTypeClass(type) {
            switch (type) {
                case 'keyword': return 'token-keyword';
                case 'identifier': return 'token-identifier';
                case 'number': return 'token-number';
                case 'operator': return 'token-operator';
                default: return '';
            }
        }

        // 语法高亮
        function highlightCode(code) {
            // 转义HTML特殊字符
            let escapedCode = code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // 高亮注释
            escapedCode = escapedCode.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="token-comment">$1</span>');
            escapedCode = escapedCode.replace(/(\/\/.*$)/gm, '<span class="token-comment">$1</span>');

            // 高亮字符串
            escapedCode = escapedCode.replace(/(".*?")/g, '<span class="token-string">$1</span>');
            escapedCode = escapedCode.replace(/('.*?')/g, '<span class="token-string">$1</span>');

            // 高亮关键字
            const keywords = ['begin', 'if', 'then', 'while', 'do', 'end', 'main',
                             'int', 'float', 'for', 'else', 'double', 'char', 'break', 'continue'];
            const keywordRegex = new RegExp(`\\b(${keywords.join('|')})\\b`, 'g');
            escapedCode = escapedCode.replace(keywordRegex, '<span class="token-keyword">$1</span>');

            // 高亮数字
            escapedCode = escapedCode.replace(/\b\d+\b/g, '<span class="token-number">$0</span>');

            // 高亮运算符和界符
            const operators = [':=', '<>', '<=', '>=', '==', '+', '-', '*', '/', '%',
                              '<', '>', '=', ';', '(', ')', '{', '}', '#'];
            // 需要按长度排序，先匹配长的运算符
            const sortedOperators = [...operators].sort((a, b) => b.length - a.length);
            const operatorRegex = new RegExp(`(${sortedOperators.map(op => escapeRegExp(op)).join('|')})`, 'g');
            escapedCode = escapedCode.replace(operatorRegex, '<span class="token-operator">$1</span>');

            return escapedCode;
        }

        // 转义正则表达式特殊字符
        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // UI状态管理
        function hideAllMessages() {
            resultPlaceholder.classList.add('hidden');
            resultContent.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function showPlaceholder() {
            resultPlaceholder.classList.remove('hidden');
        }

        function showResult() {
            resultContent.classList.remove('hidden');
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function showLoading() {
            hideAllMessages();
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateLineNumbers();
            console.log('词法分析器已加载');
        });
    </script>
</body>
</html>
